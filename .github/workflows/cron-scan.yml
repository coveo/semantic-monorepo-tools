name: "Recurring Security Scan"

on:
  schedule:
    - cron: "17 2 * * 2"

jobs:
  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript"]

    steps:
      - uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846 # tag=v3
      - name: CodeQL
        uses: ./.github/actions/codeql
        with:
          language: ${{ matrix.language }}

  snyk:
    name: Snyk
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846 # tag=v3
      - uses: ./.github/actions/setup
      - name: Prepare Snyk
        run: mkdir sarifs
      - name: Snyk Monitor
        if: ${{ github.event_name != 'pull_request' }}
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: npx snyk monitor
      - name: Snyk Test
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: npx snyk test --dev --sarif-file-output=./sarifs/snyk.sarif
      - name: Snyk Code
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: npx snyk code test    --dev --sarif > ./sarifs/snyk-code.sarif
      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@0e9acb6e5cd338179ea69a99146ca55f796799e0 # tag=v1
        with:
          sarif_file: ./sarifs
      - name: Check SnykCode vuln
        continue-on-error: true
        if: ${{ inputs.fail-on-vuln }}
        run: node ./scripts/get-scan-results.js
